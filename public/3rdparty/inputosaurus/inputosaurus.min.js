(function(e){var t={version:"0.1.6",eventprefix:"inputosaurus",options:{inputDelimiters:[",",";"],outputDelimiter:",",allowDuplicates:false,parseOnBlur:false,wrapperElement:null,width:null,autoCompleteSource:"",activateFinalResult:false,parseHook:null,placeholder:null,caseSensitiveDuplicates:false},_create:function(){var t=this,n={},r=t.options,i=r.placeholder||this.element.attr("placeholder")||null;this._chosenValues=[];n.ul=e('<ul class="inputosaurus-container">');n.input=e('<input type="text" />');n.inputCont=e('<li class="inputosaurus-input inputosaurus-required"></li>');n.origInputCont=e('<li class="inputosaurus-input-hidden inputosaurus-required">');if(i){r.placeholder=i;n.input.attr("placeholder",r.placeholder);if(r.width){n.input.css("min-width",r.width-50)}}r.wrapperElement&&r.wrapperElement.append(n.ul);this.element.replaceWith(r.wrapperElement||n.ul);n.origInputCont.append(this.element).hide();n.inputCont.append(n.input);n.ul.append(n.inputCont);n.ul.append(n.origInputCont);r.width&&n.ul.css("width",r.width);this.elements=n;t._attachEvents();if(e.trim(this.element.val())){n.input.val(this.element.val());this.parseInput()}this._instAutocomplete()},_instAutocomplete:function(){if(this.options.autoCompleteSource){var t=this;this.elements.input.autocomplete({position:{of:this.elements.ul},source:this.options.autoCompleteSource,minLength:1,select:function(e,n){e.preventDefault();t.elements.input.val(n.item.value);t.parseInput()},open:function(){var n=e(this).data("ui-autocomplete")||e(this).data("autocomplete");var r=n.menu,i;r.element.zIndex&&r.element.zIndex(e(this).zIndex()+1);r.element.width(t.elements.ul.outerWidth());if(t.options.activateFinalResult){i=r.element.find("li");if(i.size()===1){r[r.activate?"activate":"focus"](e.Event("click"),i)}}}})}},_autoCompleteMenuPosition:function(){var e;if(this.options.autoCompleteSource){e=this.elements.input.data("ui-autocomplete")||this.elements.input.data("autocomplete");e&&e.menu.element.position({of:this.elements.ul,my:"left top",at:"left bottom",collision:"none"})}},parseInput:function(t){var n=t&&t.data.widget||this,r,i=false,s=[];r=n.elements.input.val();r&&(i=n._containsDelimiter(r));if(i!==false){s=r.split(i)}else if(!t||t.which===e.ui.keyCode.ENTER&&!e(".ui-menu-item .ui-state-focus").size()&&!e("#ui-active-menuitem").size()){s.push(r);t&&t.preventDefault()}else if(t.type==="blur"&&!e("#ui-active-menuitem").size()){s.push(r)}e.isFunction(n.options.parseHook)&&(s=n.options.parseHook(s));if(s.length){n._setChosen(s);n.elements.input.val("");n._resizeInput()}n._resetPlaceholder()},_inputFocus:function(e){var t=e.data.widget||this;t.elements.input.value||t.options.autoCompleteSource.length&&t.elements.input.autocomplete("search","")},_inputKeypress:function(t){var n=t.data.widget||this;t.type==="keyup"&&n._trigger("keyup",t,n);switch(t.which){case e.ui.keyCode.BACKSPACE:t.type==="keydown"&&n._inputBackspace(t);break;case e.ui.keyCode.LEFT:t.type==="keydown"&&n._inputBackspace(t);break;default:n.parseInput(t);n._resizeInput(t)}if(n.options.autoCompleteSource){setTimeout(function(){n._autoCompleteMenuPosition.call(n)},200)}},_resizeInput:function(e){var t=e&&e.data.widget||this,n=t.elements.ul.width(),r=t.elements.input.val(),i=25+r.length*8;t.elements.input.width(i<n?i:n)},_resetPlaceholder:function(){var e=this.options.placeholder,t=this.elements.input,n=this.options.width||"inherit";if(e&&this.element.val().length===0){t.attr("placeholder",e).css("min-width",n-50)}else{t.attr("placeholder","").css("min-width","inherit")}},_inputBackspace:function(t){var n=t&&t.data.widget||this;lastTag=n.elements.ul.find("li:not(.inputosaurus-required):last");t.stopPropagation();if((!e(t.currentTarget).val()||"selectionStart"in t.currentTarget&&t.currentTarget.selectionStart===0&&t.currentTarget.selectionEnd===0)&&lastTag.size()){t.preventDefault();lastTag.find("a").focus()}},_editTag:function(t){var n=t&&t.data.widget||this,r="",i=e(t.currentTarget).closest("li"),s=i.data("ui-inputosaurus")||i.data("inputosaurus");if(!s){return true}t.preventDefault();e.each(n._chosenValues,function(e,t){t.key===s&&(r=t.value)});n.elements.input.val(r);n._removeTag(t);n._resizeInput(t)},_tagKeypress:function(t){var n=t.data.widget;switch(t.which){case e.ui.keyCode.BACKSPACE:t&&t.preventDefault();t&&t.stopPropagation();e(t.currentTarget).trigger("click");break;case 69:n._editTag(t);break;case e.ui.keyCode.LEFT:t.type==="keydown"&&n._prevTag(t);break;case e.ui.keyCode.RIGHT:t.type==="keydown"&&n._nextTag(t);break;case e.ui.keyCode.DOWN:t.type==="keydown"&&n._focus(t);break}},_prevTag:function(t){var n=t&&t.data.widget||this,r=e(t.currentTarget).closest("li"),i=r.prev();if(i.is("li")){i.find("a").focus()}else{n._focus()}},_nextTag:function(t){var n=t&&t.data.widget||this,r=e(t.currentTarget).closest("li"),i=r.next();if(i.is("li:not(.inputosaurus-input)")){i.find("a").focus()}else{n._focus()}},_containsDelimiter:function(t){var n=false;e.each(this.options.inputDelimiters,function(e,r){if(t.indexOf(r)!==-1){n=r}});return n},_setChosen:function(t){var n=this;if(!e.isArray(t)){return false}e.each(t,function(t,r){var i=false,s={key:"",value:""};r=e.trim(r);e.each(n._chosenValues,function(e,t){if(!n.options.caseSensitiveDuplicates){t.value.toLowerCase()===r.toLowerCase()&&(i=true)}else{t.value===r&&(i=true)}});if(r!==""&&(!i||n.options.allowDuplicates)){s.key="mi_"+Math.random().toString(16).slice(2,10);s.value=r;n._chosenValues.push(s);n._renderTags()}});n._setValue(n._buildValue())},_buildValue:function(){var t=this,n="";e.each(this._chosenValues,function(e,r){n+=n.length?t.options.outputDelimiter+r.value:r.value});return n},_setValue:function(e){var t=this.element.val();if(t!==e){this.element.val(e);this._trigger("change")}},_createTag:function(t,n,r){r=r?' class="'+r+'"':"";if(t!==undefined){return e("<li"+r+' data-inputosaurus="'+n+'"><span>'+t+'</span> <a href="javascript:void(0);" class="ficon">&#x2716;</a></li>')}},_renderTags:function(){var t=this;this.elements.ul.find("li:not(.inputosaurus-required)").remove();e.each(this._chosenValues,function(e,n){var r=t._createTag(n.value,n.key);t.elements.ul.find("li.inputosaurus-input").before(r)})},_removeTag:function(t){var n=e(t.currentTarget).closest("li"),r=n.data("ui-inputosaurus")||n.data("inputosaurus"),i=false,s=t&&t.data.widget||this;e.each(s._chosenValues,function(e,t){if(r===t.key){i=e}});i!==false&&s._chosenValues.splice(i,1);s._setValue(s._buildValue());e(t.currentTarget).closest("li").remove();s.elements.input.focus()},_focus:function(t){var n=t&&t.data.widget||this,r=e(t.target).closest("li"),i=r.data("ui-inputosaurus")||r.data("inputosaurus");if(!t||!i){n.elements.input.focus()}},_tagFocus:function(t){e(t.currentTarget).parent()[t.type==="focusout"?"removeClass":"addClass"]("inputosaurus-selected")},refresh:function(){var t=this.options.outputDelimiter,n=this.element.val(),r=[];r.push(n);t&&(r=n.split(t));if(r.length){this._chosenValues=[];e.isFunction(this.options.parseHook)&&(r=this.options.parseHook(r));this._setChosen(r);this._renderTags();this.elements.input.val("");this._resizeInput()}},_attachEvents:function(){var e=this;this.elements.input.on("keyup.inputosaurus",{widget:e},this._inputKeypress);this.elements.input.on("keydown.inputosaurus",{widget:e},this._inputKeypress);this.elements.input.on("change.inputosaurus",{widget:e},this._inputKeypress);this.elements.input.on("focus.inputosaurus",{widget:e},this._inputFocus);this.options.parseOnBlur&&this.elements.input.on("blur.inputosaurus",{widget:e},this.parseInput);this.elements.ul.on("click.inputosaurus",{widget:e},this._focus);this.elements.ul.on("click.inputosaurus","a",{widget:e},this._removeTag);this.elements.ul.on("dblclick.inputosaurus","li",{widget:e},this._editTag);this.elements.ul.on("focus.inputosaurus","a",{widget:e},this._tagFocus);this.elements.ul.on("blur.inputosaurus","a",{widget:e},this._tagFocus);this.elements.ul.on("keydown.inputosaurus","a",{widget:e},this._tagKeypress)},_destroy:function(){this.elements.input.unbind(".inputosaurus");this.elements.ul.replaceWith(this.element)}};e.widget("ui.inputosaurus",t)})(jQuery)